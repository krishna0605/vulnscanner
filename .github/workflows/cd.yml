name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Build and Push Docker Images
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-

    - name: Build and push backend image
      id: build-backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Build and push frontend image
      id: build-frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.vulnscanner.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Deploy to ECS Staging
      run: |
        # Update ECS task definition with new image
        aws ecs describe-task-definition --task-definition vulnscanner-staging-backend --query taskDefinition > task-def-backend.json
        aws ecs describe-task-definition --task-definition vulnscanner-staging-frontend --query taskDefinition > task-def-frontend.json
        
        # Update image URIs
        jq --arg IMAGE "${{ needs.build-and-push.outputs.backend-image }}" '.containerDefinitions[0].image = $IMAGE' task-def-backend.json > task-def-backend-updated.json
        jq --arg IMAGE "${{ needs.build-and-push.outputs.frontend-image }}" '.containerDefinitions[0].image = $IMAGE' task-def-frontend.json > task-def-frontend-updated.json
        
        # Register new task definitions
        aws ecs register-task-definition --cli-input-json file://task-def-backend-updated.json
        aws ecs register-task-definition --cli-input-json file://task-def-frontend-updated.json
        
        # Update services
        aws ecs update-service --cluster vulnscanner-staging --service vulnscanner-backend --task-definition vulnscanner-staging-backend
        aws ecs update-service --cluster vulnscanner-staging --service vulnscanner-frontend --task-definition vulnscanner-staging-frontend

    - name: Wait for deployment
      run: |
        aws ecs wait services-stable --cluster vulnscanner-staging --services vulnscanner-backend vulnscanner-frontend

    - name: Run smoke tests
      run: |
        # Wait for services to be ready
        sleep 60
        
        # Health check
        curl -f https://staging-api.vulnscanner.example.com/api/v1/health || exit 1
        
        # Basic functionality test
        curl -f https://staging.vulnscanner.example.com || exit 1

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'üöÄ Staging deployment successful!'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://vulnscanner.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Create database backup
      run: |
        # Create RDS snapshot before deployment
        SNAPSHOT_ID="vulnscanner-prod-$(date +%Y%m%d-%H%M%S)"
        aws rds create-db-snapshot --db-instance-identifier vulnscanner-prod --db-snapshot-identifier $SNAPSHOT_ID
        aws rds wait db-snapshot-completed --db-snapshot-identifier $SNAPSHOT_ID

    - name: Deploy to ECS Production
      run: |
        # Blue-Green deployment strategy
        # Update ECS task definition with new image
        aws ecs describe-task-definition --task-definition vulnscanner-prod-backend --query taskDefinition > task-def-backend.json
        aws ecs describe-task-definition --task-definition vulnscanner-prod-frontend --query taskDefinition > task-def-frontend.json
        
        # Update image URIs
        jq --arg IMAGE "${{ needs.build-and-push.outputs.backend-image }}" '.containerDefinitions[0].image = $IMAGE' task-def-backend.json > task-def-backend-updated.json
        jq --arg IMAGE "${{ needs.build-and-push.outputs.frontend-image }}" '.containerDefinitions[0].image = $IMAGE' task-def-frontend.json > task-def-frontend-updated.json
        
        # Register new task definitions
        aws ecs register-task-definition --cli-input-json file://task-def-backend-updated.json
        aws ecs register-task-definition --cli-input-json file://task-def-frontend-updated.json
        
        # Update services with rolling deployment
        aws ecs update-service --cluster vulnscanner-prod --service vulnscanner-backend --task-definition vulnscanner-prod-backend --deployment-configuration maximumPercent=200,minimumHealthyPercent=50
        aws ecs update-service --cluster vulnscanner-prod --service vulnscanner-frontend --task-definition vulnscanner-prod-frontend --deployment-configuration maximumPercent=200,minimumHealthyPercent=50

    - name: Wait for deployment
      run: |
        aws ecs wait services-stable --cluster vulnscanner-prod --services vulnscanner-backend vulnscanner-frontend

    - name: Run production smoke tests
      run: |
        # Wait for services to be ready
        sleep 60
        
        # Health check
        curl -f https://api.vulnscanner.example.com/api/v1/health || exit 1
        
        # Basic functionality test
        curl -f https://vulnscanner.example.com || exit 1
        
        # Database connectivity test
        curl -f https://api.vulnscanner.example.com/api/v1/health/db || exit 1

    - name: Update monitoring dashboards
      run: |
        # Update Grafana dashboards with new deployment info
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GRAFANA_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{"tags":["deployment"],"text":"Production deployment completed","time":'"$(date +%s000)"'}' \
          https://grafana.vulnscanner.example.com/api/annotations

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: 'üéâ Production deployment successful! Version: ${{ github.ref_name }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Rollback Job (Manual Trigger)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    needs: [deploy-staging, deploy-production]
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Rollback ECS services
      run: |
        # Get previous task definition revision
        CLUSTER="${{ github.event.inputs.environment == 'production' && 'vulnscanner-prod' || 'vulnscanner-staging' }}"
        BACKEND_SERVICE="${{ github.event.inputs.environment == 'production' && 'vulnscanner-backend' || 'vulnscanner-backend' }}"
        FRONTEND_SERVICE="${{ github.event.inputs.environment == 'production' && 'vulnscanner-frontend' || 'vulnscanner-frontend' }}"
        
        # Rollback to previous revision
        aws ecs update-service --cluster $CLUSTER --service $BACKEND_SERVICE --task-definition vulnscanner-${{ github.event.inputs.environment || 'staging' }}-backend:PREVIOUS
        aws ecs update-service --cluster $CLUSTER --service $FRONTEND_SERVICE --task-definition vulnscanner-${{ github.event.inputs.environment || 'staging' }}-frontend:PREVIOUS
        
        # Wait for rollback to complete
        aws ecs wait services-stable --cluster $CLUSTER --services $BACKEND_SERVICE $FRONTEND_SERVICE

    - name: Notify rollback
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "‚ö†Ô∏è Rollback completed for ${{ github.event.inputs.environment || 'staging' }} environment",
            "color": "warning"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
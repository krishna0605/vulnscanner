'use client';

import { useResizeDetector } from 'react-resize-detector';
import dynamic from 'next/dynamic';
import { useCallback, useRef } from 'react';
import type { GraphData } from '@/lib/api';

// Dynamic import to avoid SSR issues with canvas
const ForceGraph2D = dynamic(() => import('react-force-graph-2d'), { ssr: false });

export function VulnerabilityGraph({ data }: { data: GraphData }) {
  const { width, height, ref } = useResizeDetector();
  const graphRef = useRef<any>(null);

  const handleNodeClick = useCallback((node: any) => {
    // Zoom to node on click
    if (graphRef.current) {
      graphRef.current.centerAt(node.x, node.y, 1000);
      graphRef.current.zoom(8, 2000);
    }
  }, []);

  return (
    <div
      ref={ref}
      className="lg:col-span-2 glass-card h-[400px] flex flex-col group border border-white/5 bg-white/[0.02] backdrop-blur-xl rounded-[24px] relative overflow-hidden"
    >
      {/* Subtle Grid Background - Blended */}
      <div
        className="absolute inset-0 z-0 opacity-10 pointer-events-none"
        style={{
          backgroundImage:
            'linear-gradient(#f1f5f9 1px, transparent 1px), linear-gradient(90deg, #f1f5f9 1px, transparent 1px)',
          backgroundSize: '24px 24px',
        }}
      />

      {/* Radial Vignette for focus */}
      <div className="absolute inset-0 z-0 bg-radial-gradient from-transparent via-transparent to-black/60 pointer-events-none" />

      <div className="absolute top-4 left-6 z-10 pointer-events-none">
        <div className="flex items-center gap-2">
          <span className="material-symbols-outlined text-slate-400">hub</span>
          <h3 className="font-bold text-white">Vulnerability Graph</h3>
        </div>
        <p className="text-[10px] text-slate-500 font-mono mt-1">RELATIONSHIP VIEW</p>
      </div>

      {/* Legend */}
      <div className="absolute bottom-4 left-6 z-10 flex flex-col gap-1 pointer-events-none">
        <div className="flex items-center gap-2 text-[10px] text-slate-400">
          <span className="material-symbols-outlined text-[14px]">shield</span> Main System
        </div>
        <div className="flex items-center gap-2 text-[10px] text-slate-400">
          <span className="w-2 h-2 rounded-full bg-sky-500"></span> Project
        </div>
        <div className="flex items-center gap-2 text-[10px] text-slate-400">
          <span className="w-2 h-2 rounded-full bg-red-500"></span> Critical Vuln
        </div>
      </div>

      {width && height && (
        <ForceGraph2D
          ref={graphRef}
          width={width}
          height={height}
          graphData={data}
          nodeLabel="label"
          nodeColor="color"
          nodeVal="val"
          cooldownTicks={100}
          onEngineStop={() => graphRef.current?.zoomToFit(400, 50)}
          backgroundColor="rgba(0,0,0,0)" // Transparent
          linkColor={() => 'rgba(255,255,255,0.1)'}
          linkWidth={1}
          d3AlphaDecay={0.02}
          d3VelocityDecay={0.3}
          onNodeClick={handleNodeClick}
          nodeCanvasObject={(node: any, ctx, globalScale) => {
            const label = node.label;
            const fontSize = 14 / globalScale;
            const r = node.val;

            if (node.type === 'root') {
              // Render Material Icon Shield
              // Font needs to be loaded for this to work
              const size = r * 6;

              // Draw Icon Text
              ctx.font = `${size}px "Material Symbols Outlined"`;
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillStyle = '#fff'; // White shield
              ctx.fillText('shield', node.x, node.y);
            } else {
              // Standard Dots
              ctx.beginPath();
              ctx.arc(node.x, node.y, r, 0, 2 * Math.PI, false);
              ctx.fillStyle = node.color;
              ctx.fill();

              // Optional: White Border for contrast
              ctx.strokeStyle = 'rgba(255,255,255,0.1)';
              ctx.lineWidth = 0.5 / globalScale;
              ctx.stroke();
            }

            // Labels
            if (node.type === 'root' || node.type === 'project' || globalScale > 2) {
              ctx.font = `${fontSize}px Sans-Serif`;
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillStyle = 'rgba(255,255,255,0.9)';
              // Position text below
              const yOffset = node.type === 'root' ? r * 4 : r + fontSize + 2;
              ctx.fillText(label, node.x, node.y + yOffset);
            }
          }}
        />
      )}
    </div>
  );
}
